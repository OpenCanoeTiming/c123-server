# C123 Server WebSocket Protocol

This document describes the WebSocket protocol provided by C123 Server for scoreboard clients.

> **Note:** For documentation of the native Canoe123 TCP/UDP protocol (XML format, network architecture), see:
> - `analysis/c123-protocol.md` - Native network protocol
> - `analysis/c123-xml-format.md` - XML file export format

---

## Overview

C123 Server connects to Canoe123 via TCP:27333 and transforms XML messages to JSON, providing:

- **WebSocket API** at `ws://server:3001/ws` for real-time data
- **REST API** at `http://server:3001/api` for static data and XML access

---

## WebSocket Message Format

All messages follow this envelope format:

```json
{
  "type": "MessageType",
  "timestamp": "2025-01-02T10:30:45.123Z",
  "data": { ... }
}
```

---

## Message Types from C123

These messages are transformed from native C123 XML:

### TimeOfDay

Heartbeat with system time (~1/second).

```json
{
  "type": "TimeOfDay",
  "timestamp": "2025-01-02T19:04:20.000Z",
  "data": {
    "time": "19:04:20"
  }
}
```

### OnCourse

Competitors currently on course (~2/second during racing).

```json
{
  "type": "OnCourse",
  "timestamp": "2025-01-02T16:14:08.115Z",
  "data": {
    "total": 2,
    "competitors": [
      {
        "bib": "9",
        "name": "KOPEČEK Michal",
        "club": "VS Tábor",
        "nat": "",
        "raceId": "K1M_ST_BR2_6",
        "raceName": "K1m - střední trať - 2. jízda",
        "startOrder": 9,
        "warning": "",
        "gates": "0,0,0,2,0,0,2,0,50,,,,,,,,,,,,,,,",
        "completed": false,
        "dtStart": "16:14:00.000",
        "dtFinish": null,
        "pen": 54,
        "time": "8115",
        "total": "8169",
        "ttbDiff": "+12.79",
        "ttbName": "J. KREJČÍ",
        "rank": 8,
        "position": 1
      }
    ]
  }
}
```

**Field Reference:**

| Field | Type | Description |
|-------|------|-------------|
| `bib` | string | Start number |
| `name` | string | Full name |
| `club` | string | Club name |
| `raceId` | string | Race identifier |
| `gates` | string | Penalties per gate: `0`=clean, `2`=touch, `50`=miss |
| `dtStart` | string | Start timestamp |
| `dtFinish` | string\|null | Finish timestamp (null until finish) |
| `pen` | number | Total penalty seconds |
| `time` | string | Running time in centiseconds |
| `total` | string | Total time (time + penalties) |
| `ttbDiff` | string | Difference to leader |
| `rank` | number | Current rank |
| `position` | number | Position on course (1 = closest to finish) |

### Results

Result table for a race.

```json
{
  "type": "Results",
  "timestamp": "2025-01-02T10:30:46.456Z",
  "data": {
    "raceId": "K1M_ST_BR2_6",
    "classId": "K1M_ST",
    "isCurrent": true,
    "mainTitle": "K1m - střední trať",
    "subTitle": "1st and 2nd Run",
    "rows": [
      {
        "rank": 1,
        "bib": "1",
        "name": "KREJČÍ Jakub",
        "club": "TJ DUKLA Praha",
        "gates": "0 0 0 0 0 0 0 0 0 0 0 0 2 0 2 0 2 0 0 0 0 0 0 0",
        "pen": 2,
        "time": "79.99",
        "total": "78.99",
        "behind": ""
      }
    ]
  }
}
```

**Note:** `isCurrent: true` indicates the active race. C123 rotates through all categories periodically.

### RaceConfig

Course configuration.

```json
{
  "type": "RaceConfig",
  "timestamp": "2025-01-02T10:30:00.000Z",
  "data": {
    "nrSplits": 0,
    "nrGates": 24,
    "gateConfig": "NNRNNRNRNNNRNNRNRNNRNNRN",
    "gateCaptions": "1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24"
  }
}
```

Gate config: `N` = Normal (downstream), `R` = Reverse (upstream).

### Schedule

List of races in competition.

```json
{
  "type": "Schedule",
  "timestamp": "2025-01-02T10:30:00.000Z",
  "data": {
    "races": [
      {
        "order": 101,
        "raceId": "K1M_ST_BR1_6",
        "race": "K1m - střední trať - 1. jízda",
        "mainTitle": "K1m - střední trať",
        "subTitle": "1st Run",
        "raceStatus": 5
      }
    ]
  }
}
```

Race status: `3` = Running, `5` = Finished.

---

## Server-Generated Messages

These messages are generated by C123 Server (not from C123):

### Connected

Sent immediately when WebSocket client connects:

```json
{
  "type": "Connected",
  "timestamp": "2025-01-02T10:30:00.000Z",
  "data": {
    "version": "2.0.0",
    "c123Connected": true,
    "xmlLoaded": true
  }
}
```

### Error

Sent when errors occur:

```json
{
  "type": "Error",
  "timestamp": "2025-01-02T10:30:00.000Z",
  "data": {
    "code": "CONNECTION_LOST",
    "message": "Lost connection to C123"
  }
}
```

### XmlChange

Sent when XML file changes:

```json
{
  "type": "XmlChange",
  "timestamp": "2025-01-02T10:31:00.000Z",
  "data": {
    "sections": ["Results", "Participants"],
    "checksum": "abc123def456..."
  }
}
```

### ForceRefresh

Admin-triggered refresh command:

```json
{
  "type": "ForceRefresh",
  "timestamp": "2025-01-02T10:32:00.000Z",
  "data": {
    "reason": "Admin triggered refresh"
  }
}
```

### ConfigPush

Remote configuration for client:

```json
{
  "type": "ConfigPush",
  "timestamp": "2025-01-05T10:30:00.000Z",
  "data": {
    "type": "ledwall",
    "displayRows": 8,
    "customTitle": "Finish Line Display",
    "label": "TV in Hall A",
    "clientId": "finish-display",
    "assets": {
      "logoUrl": "data:image/png;base64,..."
    }
  }
}
```

See [CLIENT-CONFIG.md](CLIENT-CONFIG.md) for complete configuration documentation.

### LogEntry

Real-time log for admin dashboard:

```json
{
  "type": "LogEntry",
  "timestamp": "2025-01-02T10:31:15.000Z",
  "data": {
    "level": "info",
    "component": "TcpSource",
    "message": "Connected to C123"
  }
}
```

---

## Client-to-Server Messages

### ClientState

Client reports its current configuration:

```json
{
  "type": "ClientState",
  "timestamp": "2025-01-05T10:30:01.000Z",
  "data": {
    "current": {
      "type": "ledwall",
      "displayRows": 8
    },
    "version": "3.0.0",
    "capabilities": ["configPush", "forceRefresh"]
  }
}
```

---

## Finish Detection

There is no explicit "finish" event. Detect finish by watching `dtFinish`:

```typescript
function detectFinish(prev: Competitor[], curr: Competitor[]) {
  for (const c of curr) {
    const p = prev.find(x => x.bib === c.bib);
    if (p && !p.dtFinish && c.dtFinish) {
      return c; // Just finished!
    }
  }
  return null;
}
```

Timeline:
- `t=0`: `dtFinish` changes from `null` to timestamp
- `t+4s`: Competitor disappears from OnCourse

---

## BR1/BR2 (Two-Run) Handling

**Critical:** In BR2 Results, `pen` and `total` may contain BR1 values when BR1 was better!

| Field | Expected | Actual in BR2 |
|-------|----------|---------------|
| `time` | BR2 time | BR2 time ✓ |
| `pen` | BR2 penalty | **Better run penalty** |
| `total` | BR2 total | **Best of both runs** |

**Recommendation:**
- Use OnCourse `pen` for real-time BR2 data
- Use REST API `?merged=true` for complete both-run data

See [INTEGRATION.md](INTEGRATION.md#br1br2-merge-strategy) for details.

---

## See Also

- [REST-API.md](REST-API.md) - REST endpoints
- [CLIENT-CONFIG.md](CLIENT-CONFIG.md) - Remote client configuration
- [INTEGRATION.md](INTEGRATION.md) - Scoreboard integration guide
- `analysis/c123-protocol.md` - Native C123 TCP/UDP protocol
- `analysis/c123-xml-format.md` - XML file format
