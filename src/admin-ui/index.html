<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C123 Server - Admin Dashboard</title>
  <link rel="stylesheet" href="/admin-ui/styles.css">
</head>
<body>
  <!-- Header with global status -->
  <header class="header">
    <span class="header-title">C123-SERVER</span>
    <div class="header-status">
      <span class="header-status-item" id="headerPort">:27123</span>
      <span class="header-status-item">
        <span class="status" id="headerTcpStatus"></span>
        <span>TCP</span>
      </span>
      <span class="header-status-item">
        <span class="status" id="headerUdpStatus"></span>
        <span>UDP</span>
      </span>
      <span class="header-status-item">
        <span class="status" id="headerXmlStatus"></span>
        <span>XML</span>
      </span>
      <span class="header-live" id="headerLive" style="display: none;">
        <span class="status connected"></span>
        <span>LIVE</span>
      </span>
    </div>
  </header>

  <main class="main-content">

  <!-- Event Info Bar (prominent position) -->
  <div class="event-bar">
    <div class="event-bar-main">
      <div class="event-race" id="currentRace">-</div>
      <div class="event-name">
        Event: <span class="event-name-value" id="eventName">-</span>
        <span id="eventSource" style="color: var(--text-muted);"></span>
      </div>
    </div>
    <div class="event-bar-form">
      <input type="text" id="eventNameInput" placeholder="Event name override">
      <button class="btn" onclick="setEventName()">Set</button>
      <button class="btn btn-secondary" onclick="clearEventName()">Clear</button>
    </div>
    <div id="eventError" class="error" style="display: none;"></div>
  </div>

  <!-- Compact Status Bar -->
  <div class="status-bar" id="statusBar">
    <!-- Dynamically populated -->
  </div>

  <!-- Tab Navigation -->
  <div class="tabs" role="tablist">
    <button class="tab active" role="tab" aria-selected="true" data-tab="sources" onclick="switchTab('sources')">Sources</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="xml" onclick="switchTab('xml')">XML</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="clients" onclick="switchTab('clients')">Clients</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="assets" onclick="switchTab('assets')">Assets</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="logs" onclick="switchTab('logs')">Logs</button>
  </div>

  <!-- Tab Panels -->

  <!-- Sources Panel -->
  <div class="tab-panel active" id="panel-sources" role="tabpanel">
    <div class="card">
      <table id="sourcesTable">
        <thead><tr><th>Name</th><th>Type</th><th>Status</th><th>Details</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- XML Configuration Panel -->
  <div class="tab-panel" id="panel-xml" role="tabpanel">
    <div class="card" id="xmlConfigCard">
      <div style="margin-bottom: 10px;">
        <strong>Current path:</strong> <span id="xmlPath">-</span>
        <span id="xmlSource" style="margin-left: 10px; color: var(--text-secondary);"></span>
      </div>

      <!-- Mode selector (Windows only) -->
      <div id="modeSelector" style="display: none; margin-bottom: 15px;">
        <strong style="display: block; margin-bottom: 8px;">Source mode:</strong>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
            <input type="radio" name="xmlMode" value="auto-offline" style="margin-top: 3px;">
            <div>
              <div>Auto - offline copy (recommended)</div>
              <div id="offlinePath" style="font-size: 0.85em; color: var(--text-secondary);"></div>
            </div>
          </label>
          <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
            <input type="radio" name="xmlMode" value="auto-main" style="margin-top: 3px;">
            <div>
              <div>Auto - main event file</div>
              <div id="mainPath" style="font-size: 0.85em; color: var(--text-secondary);"></div>
            </div>
          </label>
          <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
            <input type="radio" name="xmlMode" value="manual" style="margin-top: 3px;">
            <div>Manual path</div>
          </label>
        </div>
      </div>

      <!-- Manual path input -->
      <div id="manualPathSection" class="config-form">
        <input type="text" id="xmlPathInput" placeholder="XML file path" style="flex: 1; min-width: 200px; padding: 6px; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary);">
        <button class="btn" onclick="setXmlPath()">Set Path</button>
      </div>
      <div id="xmlConfigError" class="error" style="margin-top: 10px; display: none;"></div>
    </div>
  </div>

  <!-- Clients Panel -->
  <div class="tab-panel" id="panel-clients" role="tabpanel">
    <div class="card">
      <!-- Clients header with stats and actions -->
      <div class="clients-header">
        <div class="clients-header-left">
          <div class="clients-count">
            <div class="clients-count-item online">
              <span class="count" id="clientsOnlineCount">0</span>
              <span>online</span>
            </div>
            <div class="clients-count-item total">
              <span class="count" id="clientsTotalCount">0</span>
              <span>total</span>
            </div>
          </div>
        </div>
        <button class="btn" onclick="refreshAllClients()" style="background: var(--warning); color: var(--bg-body);">
          <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor" style="margin-right: 4px;">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
          </svg>
          Refresh All
        </button>
      </div>

      <!-- Clients grid -->
      <div id="clientsGrid" class="clients-grid"></div>

      <!-- Empty state -->
      <div id="noClients" class="clients-empty" style="display: none;">
        <svg class="clients-empty-icon" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/>
        </svg>
        <div class="clients-empty-text">No clients connected</div>
        <div class="clients-empty-hint">Clients will appear here when they connect to the server</div>
      </div>
    </div>
  </div>

  <!-- Client detail modal (E2: Enhanced design) -->
  <div id="clientModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <svg class="modal-header-icon" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/>
          </svg>
          <span id="modalClientIp"></span>
        </h3>
        <button class="modal-close" onclick="closeClientModal()" aria-label="Close">&times;</button>
      </div>

      <div class="modal-body">
        <!-- Basic Info Section -->
        <div class="modal-section">
          <div class="modal-section-title">Basic Info</div>

          <div class="modal-field">
            <label class="modal-field-label">Label</label>
            <div class="modal-field-row">
              <input type="text" id="modalLabel" class="modal-input" placeholder="e.g. Finish Line Display">
              <button class="btn" onclick="saveClientLabel()">Save</button>
            </div>
          </div>
        </div>

        <!-- Display Settings Section -->
        <div class="modal-section">
          <div class="modal-section-title">Display Settings</div>

          <div class="modal-field">
            <label class="modal-field-label">Layout Type</label>
            <select id="modalType" class="modal-select">
              <option value="">(auto - detect from screen)</option>
              <option value="vertical">Vertical (standard monitors)</option>
              <option value="ledwall">LED Wall (wide format)</option>
            </select>
          </div>

          <div class="modal-field">
            <label class="modal-field-label">Display Rows</label>
            <input type="number" id="modalDisplayRows" class="modal-input" min="3" max="20" placeholder="(auto - based on screen height)">
            <div class="modal-field-hint">Number of result rows to show (3-20)</div>
          </div>

          <div class="modal-field">
            <label class="modal-field-label">Custom Title</label>
            <input type="text" id="modalCustomTitle" class="modal-input" placeholder="(none - uses event name)">
          </div>

          <div class="modal-field">
            <label class="modal-checkbox">
              <input type="checkbox" id="modalScrollToFinished" checked>
              <div class="modal-checkbox-content">
                <div class="modal-checkbox-label">Scroll to Finished</div>
                <div class="modal-checkbox-hint">When enabled, scoreboard scrolls to show finished competitor. When disabled, only highlights.</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Identity Section -->
        <div class="modal-section">
          <div class="modal-section-title">Identity</div>

          <div class="modal-field">
            <label class="modal-field-label">Client ID</label>
            <input type="text" id="modalClientId" class="modal-input" placeholder="(none - uses IP address)">
            <div class="modal-field-hint">Assign a persistent ID. Client will use this ID for future connections instead of IP.</div>
          </div>

          <div class="modal-field">
            <label class="modal-field-label">Client State (reported)</label>
            <pre id="modalClientState" class="modal-client-state">-</pre>
          </div>
        </div>

        <!-- Asset Overrides Section -->
        <div class="modal-section">
          <div class="modal-section-title">Asset Overrides</div>

          <div class="modal-asset-item">
            <label>Logo</label>
            <div class="modal-asset-drop-zone" id="modalLogoDropZone" data-key="logoUrl" tabindex="0">
              <div class="modal-asset-preview" id="modalLogoPreview"></div>
              <div class="modal-asset-placeholder" id="modalLogoPlaceholder">Drop, paste or click to upload</div>
              <input type="file" id="modalLogoInput" accept="image/*" style="display: none;">
            </div>
            <div class="modal-asset-controls">
              <button class="btn btn-secondary" onclick="clearModalAsset('logoUrl')">Clear</button>
              <button class="btn btn-secondary" onclick="useDefaultAsset('logoUrl')">Use Default</button>
            </div>
            <div class="modal-asset-info" id="modalLogoInfo"></div>
          </div>

          <div class="modal-asset-item">
            <label>Partner Logo</label>
            <div class="modal-asset-drop-zone" id="modalPartnerLogoDropZone" data-key="partnerLogoUrl" tabindex="0">
              <div class="modal-asset-preview" id="modalPartnerLogoPreview"></div>
              <div class="modal-asset-placeholder" id="modalPartnerLogoPlaceholder">Drop, paste or click to upload</div>
              <input type="file" id="modalPartnerLogoInput" accept="image/*" style="display: none;">
            </div>
            <div class="modal-asset-controls">
              <button class="btn btn-secondary" onclick="clearModalAsset('partnerLogoUrl')">Clear</button>
              <button class="btn btn-secondary" onclick="useDefaultAsset('partnerLogoUrl')">Use Default</button>
            </div>
            <div class="modal-asset-info" id="modalPartnerLogoInfo"></div>
          </div>

          <div class="modal-asset-item">
            <label>Footer Banner</label>
            <div class="modal-asset-drop-zone" id="modalFooterImageDropZone" data-key="footerImageUrl" tabindex="0">
              <div class="modal-asset-preview" id="modalFooterImagePreview"></div>
              <div class="modal-asset-placeholder" id="modalFooterImagePlaceholder">Drop, paste or click to upload</div>
              <input type="file" id="modalFooterImageInput" accept="image/*" style="display: none;">
            </div>
            <div class="modal-asset-controls">
              <button class="btn btn-secondary" onclick="clearModalAsset('footerImageUrl')">Clear</button>
              <button class="btn btn-secondary" onclick="useDefaultAsset('footerImageUrl')">Use Default</button>
            </div>
            <div class="modal-asset-info" id="modalFooterImageInfo"></div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" onclick="saveClientConfig()">Save Configuration</button>
        <button class="btn btn-danger" onclick="deleteClientConfig()">Delete</button>
      </div>

      <div id="modalError" class="error" style="padding: 10px 20px; display: none;"></div>
    </div>
  </div>

  <!-- Assets Panel (E3: Enhanced drag-and-drop UX) -->
  <div class="tab-panel" id="panel-assets" role="tabpanel">
    <div class="card">
      <p class="assets-intro">
        Configure default images for all scoreboards. Drag & drop, paste from clipboard, or click to upload.
        Per-client overrides can be set in the client configuration modal.
      </p>

      <div class="assets-grid">
        <!-- Logo -->
        <div class="asset-item">
          <div class="asset-item-header">
            <div class="asset-item-label">
              <svg viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
              Logo
            </div>
            <span class="asset-item-size">max 200×80</span>
          </div>
          <div class="asset-drop-zone" id="logoDropZone" data-key="logoUrl" tabindex="0">
            <div class="asset-preview" id="logoPreview"></div>
            <div class="asset-placeholder" id="logoPlaceholder">
              <svg class="asset-placeholder-icon" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="asset-placeholder-text">Drop image or click to upload</span>
              <span class="asset-placeholder-hint">PNG, JPG, SVG supported</span>
            </div>
            <input type="file" id="logoInput" accept="image/*" style="display: none;">
          </div>
          <div class="asset-actions">
            <input type="text" id="logoUrlInput" placeholder="Or paste URL..." class="asset-url-input">
            <button class="btn asset-btn" onclick="setAssetFromUrl('logoUrl')">Load</button>
            <button class="btn asset-btn btn-secondary" onclick="clearAsset('logoUrl')">Clear</button>
          </div>
          <div class="asset-info" id="logoInfo"></div>
        </div>

        <!-- Partner Logo -->
        <div class="asset-item">
          <div class="asset-item-header">
            <div class="asset-item-label">
              <svg viewBox="0 0 20 20" fill="currentColor">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
              </svg>
              Partner Logo
            </div>
            <span class="asset-item-size">max 300×80</span>
          </div>
          <div class="asset-drop-zone" id="partnerLogoDropZone" data-key="partnerLogoUrl" tabindex="0">
            <div class="asset-preview" id="partnerLogoPreview"></div>
            <div class="asset-placeholder" id="partnerLogoPlaceholder">
              <svg class="asset-placeholder-icon" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="asset-placeholder-text">Drop image or click to upload</span>
              <span class="asset-placeholder-hint">PNG, JPG, SVG supported</span>
            </div>
            <input type="file" id="partnerLogoInput" accept="image/*" style="display: none;">
          </div>
          <div class="asset-actions">
            <input type="text" id="partnerLogoUrlInput" placeholder="Or paste URL..." class="asset-url-input">
            <button class="btn asset-btn" onclick="setAssetFromUrl('partnerLogoUrl')">Load</button>
            <button class="btn asset-btn btn-secondary" onclick="clearAsset('partnerLogoUrl')">Clear</button>
          </div>
          <div class="asset-info" id="partnerLogoInfo"></div>
        </div>

        <!-- Footer Image -->
        <div class="asset-item" style="grid-column: 1 / -1;">
          <div class="asset-item-header">
            <div class="asset-item-label">
              <svg viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
              </svg>
              Footer Banner
            </div>
            <span class="asset-item-size">max 1920×200</span>
          </div>
          <div class="asset-drop-zone" id="footerImageDropZone" data-key="footerImageUrl" tabindex="0">
            <div class="asset-preview" id="footerImagePreview"></div>
            <div class="asset-placeholder" id="footerImagePlaceholder">
              <svg class="asset-placeholder-icon" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="asset-placeholder-text">Drop image or click to upload</span>
              <span class="asset-placeholder-hint">Wide format recommended (e.g. 1920×100)</span>
            </div>
            <input type="file" id="footerImageInput" accept="image/*" style="display: none;">
          </div>
          <div class="asset-actions">
            <input type="text" id="footerImageUrlInput" placeholder="Or paste URL..." class="asset-url-input">
            <button class="btn asset-btn" onclick="setAssetFromUrl('footerImageUrl')">Load</button>
            <button class="btn asset-btn btn-secondary" onclick="clearAsset('footerImageUrl')">Clear</button>
          </div>
          <div class="asset-info" id="footerImageInfo"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logs Panel -->
  <div class="tab-panel" id="panel-logs" role="tabpanel">
    <div class="card">
      <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center;">
        <div style="display: flex; gap: 5px; align-items: center;">
          <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
            <input type="checkbox" id="logLevelDebug" onchange="filterLogs()"> <span style="color: var(--text-secondary);">debug</span>
          </label>
          <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
            <input type="checkbox" id="logLevelInfo" checked onchange="filterLogs()"> <span style="color: var(--success);">info</span>
          </label>
          <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
            <input type="checkbox" id="logLevelWarn" checked onchange="filterLogs()"> <span style="color: var(--warning);">warn</span>
          </label>
          <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
            <input type="checkbox" id="logLevelError" checked onchange="filterLogs()"> <span style="color: var(--error);">error</span>
          </label>
        </div>
        <input type="text" id="logSearch" placeholder="Search logs..." onkeyup="filterLogs()" style="flex: 1; min-width: 150px; padding: 4px 8px; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary);">
        <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
          <input type="checkbox" id="logAutoScroll" checked> Auto-scroll
        </label>
        <button class="btn btn-secondary" onclick="clearLogDisplay()" style="padding: 4px 8px;">Clear</button>
      </div>
      <div id="logContainer" style="max-height: 400px; overflow-y: auto; font-family: var(--font-mono); font-size: 12px; background: var(--bg-input); border-radius: var(--radius-md); padding: 8px;">
        <div id="logEntries"></div>
        <div id="noLogs" style="color: var(--text-muted); padding: 10px; text-align: center;">No log entries</div>
      </div>
      <div style="margin-top: 5px; color: var(--text-muted); font-size: var(--text-xs);">
        <span id="logStats">0 entries</span>
      </div>
    </div>
  </div>

  <div id="lastUpdate"></div>

  </main>

  <script src="/admin-ui/main.js"></script>
</body>
</html>
